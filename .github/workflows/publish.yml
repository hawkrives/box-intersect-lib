# This workflow will build and (if release) publish Python distributions to PyPI
# For more information see:
#   - https://help.github.com/actions/language-and-framework-guides/using-python-with-github-actions
#   - https://packaging.python.org/en/latest/guides/publishing-package-distribution-releases-using-github-actions-ci-cd-workflows/
#

name: build-publish

on:
    push:
        branches: [main]
    release:
        types: [published]

jobs:
  build-manylinux-wheels:
    runs-on: ubuntu-latest
    if: github.event_name == 'release' && github.event.action == 'published'
    steps:
    - uses: actions/checkout@v6
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
          python-version: ${{ matrix.python-version }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
    - name: Install python dependencies
      run: |
          pip install numpy 
    - name: Build manylinux container
      run: docker build -f Dockerfile.build-manylinux . -t box-intersect-deploy
    - name: Load wheels
      run: docker cp $(docker create --name tc box-intersect-deploy):/work/box-intersect-lib-py/target/wheels ./dist
    - name: Run integration test on native built wheel
      shell: bash
      run: |
          pip install dist/*cp312*.whl
          python scripts/integration_test.py
    - name: Store wheels
      uses: actions/upload-artifact@v6
      with:
        name: dist-manylinux
        path: dist

  build-native-wheels:
    runs-on: ${{ matrix.os }}
    if: github.event_name == 'release' && github.event.action == 'published'
    strategy:
      fail-fast: false
      matrix:
          # macos-13 is x86, macos-14 is M1 ARM
          os: [windows-latest, macos-13, macos-14]
          python-version: ['3.8', '3.9', '3.10', '3.11', '3.12', '3.13']
    steps:
    - uses: actions/checkout@v6
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
          python-version: ${{ matrix.python-version }}
    - uses: actions-rust-lang/setup-rust-toolchain@v1
    - name: Install python dependencies
      run: |
          pip install maturin 
          pip install numpy
    - name: Build wheels
      shell: bash
      run: |
          ls
          cp README.md LICENSE.txt box-intersect-lib-py
          cd box-intersect-lib-py
          maturin build --release --strip
          cd ..
          cp -r box-intersect-lib-py/target/wheels dist
    - name: Run integration test on native built wheel
      shell: bash
      run: |
          pip install dist/*.whl
          python scripts/integration_test.py
    - name: Store wheels
      uses: actions/upload-artifact@v6
      with:
        name: dist-native-${{ matrix.os }}-${{ matrix.python-version }}
        path: dist

  publish:
    runs-on: ubuntu-latest
    needs:
    - build-manylinux-wheels
    - build-native-wheels
    if: github.event_name == 'release' && github.event.action == 'published'
    permissions:
      id-token: write  # IMPORTANT: this permission is mandatory for trusted publishing
    environment:
      name: release
      url: https://pypi.org/project/pipeline-lib/
    steps:
    - name: Download dists
      uses: actions/download-artifact@v6
      with:
        pattern: dist-*
        merge-multiple: true
        path: dist
    - name: Publish
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        skip-existing: true
